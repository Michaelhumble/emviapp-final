name: SEO Agent Weekly Digest

on:
  schedule:
    # Run every Monday at 9 AM UTC (1 AM PST / 4 AM EST)
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual triggering

jobs:
  seo-weekly-digest:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run SEO Agent Analysis
      run: |
        node scripts/seo-agent.mjs \
          --site=https://www.emvi.app \
          --out=reports \
          --maxDepth=6 \
          --includeSitemaps \
          --dry-run
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        
    - name: Generate Weekly Report
      run: |
        echo "# SEO Weekly Digest - $(date +%Y-%m-%d)" > reports/weekly-digest.md
        echo "" >> reports/weekly-digest.md
        echo "## Analysis Summary" >> reports/weekly-digest.md
        cat reports/seo-agent-summary.md >> reports/weekly-digest.md
        echo "" >> reports/weekly-digest.md
        echo "## Broken Links Detected" >> reports/weekly-digest.md
        if [ -f reports/broken-links.csv ]; then
          echo "Found $(wc -l < reports/broken-links.csv) broken links" >> reports/weekly-digest.md
        else
          echo "No broken links detected âœ…" >> reports/weekly-digest.md
        fi
        
    - name: Create PR with Fixes
      if: github.event_name == 'schedule'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore(seo): weekly agent fixes and optimizations'
        title: 'SEO Agent Weekly Fixes - Week of ${{ github.run_id }}'
        body: |
          ðŸ¤– **Automated SEO Agent Weekly Digest**
          
          This PR contains SEO improvements identified by the automated agent:
          
          - Canonical URL normalizations
          - JSON-LD schema enhancements  
          - Internal broken link fixes
          - Meta description improvements
          
          **Review carefully before merging** - all changes are surgical and preserve business logic.
          
          Generated by: SEO Agent v1.0
          Report: see `reports/weekly-digest.md`
        branch: seo-agent-weekly-${{ github.run_number }}
        delete-branch: true
        
    - name: Upload Reports
      uses: actions/upload-artifact@v4
      with:
        name: seo-weekly-digest-${{ github.run_number }}
        path: |
          reports/weekly-digest.md
          reports/seo-agent-summary.md
          reports/broken-links.csv
        retention-days: 30