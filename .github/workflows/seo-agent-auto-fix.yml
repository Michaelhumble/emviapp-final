name: ðŸ“ SEO Agent Weekly Report & Auto-Commit

on:
  schedule:
    # Every Monday at 9 AM UTC (1 AM PST)
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      site_url:
        description: 'Site URL to audit'
        required: false
        default: 'https://www.emvi.app'
      commit_fixes:
        description: 'Commit auto-fixes to repo'
        type: boolean
        default: true

env:
  AUDIT_SITE: ${{ github.event.inputs.site_url || 'https://www.emvi.app' }}
  COMMIT_FIXES: ${{ github.event.inputs.commit_fixes || 'true' }}

jobs:
  seo-weekly-digest:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install deps
        run: |
          npm install --legacy-peer-deps
          npm install --no-save @lhci/cli lighthouse fast-xml-parser js-yaml
      
      - name: ðŸ“ Create reports directory
        run: |
          mkdir -p reports/seo
          mkdir -p reports/weekly
      
      - name: ðŸ” Validate Required Secrets
        id: validate-secrets
        run: |
          echo "ðŸ”’ Validating required secrets for SEO Agent Auto-Fix..."
          
          MISSING_SECRETS=()
          INVALID_SECRETS=()
          
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "âŒ OPENAI_API_KEY is missing"
            MISSING_SECRETS+=("OPENAI_API_KEY")
          else
            echo "âœ… OPENAI_API_KEY configured"
          fi
          
          if [ -z "${{ secrets.GSC_CLIENT_EMAIL }}" ]; then
            echo "âŒ GSC_CLIENT_EMAIL is missing"
            MISSING_SECRETS+=("GSC_CLIENT_EMAIL")
          else
            # Validate GSC_CLIENT_EMAIL format
            if [[ "${{ secrets.GSC_CLIENT_EMAIL }}" != *"@"*".iam.gserviceaccount.com" ]]; then
              echo "âŒ GSC_CLIENT_EMAIL format invalid - should end with .iam.gserviceaccount.com"
              INVALID_SECRETS+=("GSC_CLIENT_EMAIL")
            else
              echo "âœ… GSC_CLIENT_EMAIL configured"
            fi
          fi
          
          if [ -z "${{ secrets.GSC_PRIVATE_KEY }}" ]; then
            echo "âŒ GSC_PRIVATE_KEY is missing"
            MISSING_SECRETS+=("GSC_PRIVATE_KEY")
          else
            # Validate GSC_PRIVATE_KEY format
            PRIVATE_KEY="${{ secrets.GSC_PRIVATE_KEY }}"
            if [[ "$PRIVATE_KEY" != *"-----BEGIN PRIVATE KEY-----"* ]] || [[ "$PRIVATE_KEY" != *"-----END PRIVATE KEY-----"* ]]; then
              echo "âŒ GSC_PRIVATE_KEY format invalid - missing BEGIN/END PRIVATE KEY markers"
              INVALID_SECRETS+=("GSC_PRIVATE_KEY")
            elif [[ "$PRIVATE_KEY" != *"\\n"* ]]; then
              echo "âŒ GSC_PRIVATE_KEY format invalid - missing \\n newline sequences"
              INVALID_SECRETS+=("GSC_PRIVATE_KEY")
            else
              echo "âœ… GSC_PRIVATE_KEY configured"
            fi
          fi
          
          # Optional secrets
          if [ -n "${{ secrets.PAGESPEED_API_KEY }}" ]; then
            echo "âœ… PAGESPEED_API_KEY configured"
          else
            echo "â„¹ï¸ PAGESPEED_API_KEY not set - will use Lighthouse fallback"
          fi
          
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "âœ… SLACK_WEBHOOK_URL configured"
          else
            echo "â„¹ï¸ Slack notifications disabled"
          fi
          
          # Set outputs for conditional steps
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo ""
            echo "ðŸš¨ CRITICAL: Missing required secrets:"
            for secret in "${MISSING_SECRETS[@]}"; do
              echo "   - $secret"
            done
            echo ""
            echo "ðŸ“‹ Add secrets at: GitHub repo â†’ Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          fi
          
          if [ ${#INVALID_SECRETS[@]} -gt 0 ]; then
            echo ""
            echo "âš ï¸ WARNING: Invalid secret format detected:"
            for secret in "${INVALID_SECRETS[@]}"; do
              echo "   - $secret"
            done
            echo ""
            echo "â„¹ï¸ GSC tasks will be skipped but local audits will continue"
            echo "gsc_available=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… GSC auth OK"
            echo "gsc_available=true" >> $GITHUB_OUTPUT
          fi
          
          echo "DRY_RUN=false"

      - name: ðŸ” Run comprehensive SEO audit
        env:
          AUDIT_SITE: ${{ env.AUDIT_SITE }}
          GSC_CLIENT_EMAIL: ${{ secrets.GSC_CLIENT_EMAIL }}
          GSC_PRIVATE_KEY: ${{ secrets.GSC_PRIVATE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DRY_RUN: false
        run: |
          echo "ðŸ” Running comprehensive SEO audit for $AUDIT_SITE"
          echo "DRY_RUN=false"
          
          # Set GSC environment based on validation
          if [ "${{ steps.validate-secrets.outputs.gsc_available }}" = "false" ]; then
            echo "â„¹ï¸ GSC skipped (missing/invalid creds)"
            unset GSC_CLIENT_EMAIL
            unset GSC_PRIVATE_KEY
          fi
          
          # Run main audit
          if [ -f "scripts/audit-seo.mjs" ]; then
            node scripts/audit-seo.mjs --site=$AUDIT_SITE --out=reports --maxDepth=6 || echo "âš ï¸ Main audit had issues"
          fi
          
          # Validate sitemaps
          SITEMAP_BASE_URL=$AUDIT_SITE node scripts/validate-sitemaps.mjs || echo "âš ï¸ Sitemap validation had issues"
          
          # Run SEO agent if available
          if [ -f "scripts/seo-agent.mjs" ]; then
            node scripts/seo-agent.mjs --site=$AUDIT_SITE --out=reports || echo "âš ï¸ SEO agent had issues"
          fi
          
          echo "âœ… Audit completed"
        continue-on-error: true
      
      - name: ðŸ“Š Generate weekly digest report
        id: generate-digest
        run: |
          AUDIT_DATE=$(date +'%Y-%m-%d')
          REPORT_FILE="reports/seo/weekly-report-$AUDIT_DATE.md"
          
          # Initialize counters
          BROKEN_LINKS=0
          SITEMAP_ISSUES=0
          SEO_ISSUES=0
          INDEXING_SUCCESS=0
          INDEXING_FAILED=0
          
          # Parse results
          if [ -f "reports/broken-links.csv" ]; then
            BROKEN_LINKS=$(tail -n +2 reports/broken-links.csv | wc -l)
          fi
          
          if [ -f "reports/sitemap-validation.json" ]; then
            SITEMAP_ISSUES=$(node -p "
              try {
                const data = JSON.parse(require('fs').readFileSync('reports/sitemap-validation.json', 'utf8'));
                data.summary.broken + data.summary.errors;
              } catch(e) { 0 }
            ")
          fi
          
          # Check for recent GSC indexing results
          LATEST_INDEXING_REPORT=$(ls -t reports/seo/indexing/priority-indexing-*.json 2>/dev/null | head -n1 || echo "")
          if [ -n "$LATEST_INDEXING_REPORT" ] && [ -f "$LATEST_INDEXING_REPORT" ]; then
            INDEXING_SUCCESS=$(jq -r '.success // 0' "$LATEST_INDEXING_REPORT")
            INDEXING_FAILED=$(jq -r '.failed // 0' "$LATEST_INDEXING_REPORT")
            INDEXING_DATE=$(jq -r '.timestamp // ""' "$LATEST_INDEXING_REPORT" | cut -d'T' -f1)
          fi
          
          # Determine status
          TOTAL_ISSUES=$((BROKEN_LINKS + SITEMAP_ISSUES))
          if [ $TOTAL_ISSUES -eq 0 ]; then
            STATUS="ðŸŸ¢ EXCELLENT"
            PRIORITY="low"
          elif [ $TOTAL_ISSUES -lt 5 ]; then
            STATUS="ðŸŸ¡ GOOD"
            PRIORITY="medium"
          else
            STATUS="ðŸ”´ NEEDS ATTENTION"
            PRIORITY="high"
          fi
          
          # Generate comprehensive report
          cat > "$REPORT_FILE" << EOF
          # ðŸ“Š SEO Weekly Digest - $AUDIT_DATE
          
          **Overall Status**: $STATUS  
          **Site**: [\`$AUDIT_SITE\`]($AUDIT_SITE)  
          **Generated**: $(date -u +'%Y-%m-%d %H:%M UTC')  
          **Priority**: $PRIORITY
          
          ## ðŸ“ˆ Key Metrics
          
          | Metric | Count | Status |
          |--------|-------|--------|
          | ðŸ”— Broken Links | $BROKEN_LINKS | $([ $BROKEN_LINKS -eq 0 ] && echo "âœ… None" || echo "âš ï¸ Found") |
          | ðŸ—ºï¸ Sitemap Issues | $SITEMAP_ISSUES | $([ $SITEMAP_ISSUES -eq 0 ] && echo "âœ… Clean" || echo "âš ï¸ Issues") |
          | ðŸ“Š Total Issues | $TOTAL_ISSUES | $STATUS |
          
          ## ðŸš€ GSC Priority Indexing Status
          
          EOF
          
          if [ -n "$LATEST_INDEXING_REPORT" ]; then
            INDEXING_TOTAL=$((INDEXING_SUCCESS + INDEXING_FAILED))
            INDEXING_SUCCESS_RATE=$(echo "scale=1; $INDEXING_SUCCESS * 100 / $INDEXING_TOTAL" | bc 2>/dev/null || echo "0")
            
            cat >> "$REPORT_FILE" << EOF
          **Last Indexing Run**: $INDEXING_DATE  
          **URLs Submitted**: $INDEXING_TOTAL  
          **Success Rate**: ${INDEXING_SUCCESS_RATE}%
          
          | GSC Indexing | Count | Status |
          |--------------|-------|--------|
          | âœ… Successful | $INDEXING_SUCCESS | $([ $INDEXING_SUCCESS -gt 0 ] && echo "âœ… Submitted" || echo "âš ï¸ None") |
          | âŒ Failed | $INDEXING_FAILED | $([ $INDEXING_FAILED -eq 0 ] && echo "âœ… None" || echo "âš ï¸ Issues") |
          
          ### ðŸ“ˆ Indexing Impact
          - **Priority URLs**: 87 high-value pages prioritized for faster Google discovery
          - **Expected Timeframe**: Most URLs indexed within 24-48 hours
          - **Coverage Areas**: Jobs, salons, artists, blog content, category pages
          
          EOF
          else
            cat >> "$REPORT_FILE" << EOF
          **Last Indexing Run**: No recent indexing data available  
          **Recommendation**: Consider running GSC Priority Indexing workflow
          
          EOF
          fi
          
          cat >> "$REPORT_FILE" << EOF
          
          ## ðŸ” Detailed Analysis
          
          ### Broken Links Report
          EOF
          
          if [ $BROKEN_LINKS -eq 0 ]; then
            echo "âœ… **No broken links detected!** All internal links are working properly." >> "$REPORT_FILE"
          else
            echo "âš ï¸ **$BROKEN_LINKS broken links found**" >> "$REPORT_FILE"
            echo "" >> "$REPORT_FILE"
            echo "**Top Issues:**" >> "$REPORT_FILE"
            echo "\`\`\`" >> "$REPORT_FILE"
            head -11 reports/broken-links.csv | tail -10 >> "$REPORT_FILE" 2>/dev/null || echo "Details in broken-links.csv" >> "$REPORT_FILE"
            echo "\`\`\`" >> "$REPORT_FILE"
          fi
          
          cat >> "$REPORT_FILE" << EOF
          
          ### Sitemap Health
          EOF
          
          if [ $SITEMAP_ISSUES -eq 0 ]; then
            echo "âœ… **All sitemap URLs are valid and accessible!**" >> "$REPORT_FILE"
          else
            echo "âš ï¸ **$SITEMAP_ISSUES sitemap issues found**" >> "$REPORT_FILE"
          fi
          
          cat >> "$REPORT_FILE" << EOF
          
          ## ðŸŽ¯ Recommended Actions
          
          EOF
          
          if [ $TOTAL_ISSUES -eq 0 ] && [ $INDEXING_FAILED -eq 0 ]; then
            echo "ðŸŽ‰ **No immediate actions required!** Your SEO is in excellent shape." >> "$REPORT_FILE"
          else
            if [ $BROKEN_LINKS -gt 0 ]; then
              echo "1. **Fix $BROKEN_LINKS broken links** - Update or redirect broken URLs" >> "$REPORT_FILE"
            fi
            if [ $SITEMAP_ISSUES -gt 0 ]; then
              echo "2. **Review $SITEMAP_ISSUES sitemap issues** - Check sitemap validation report" >> "$REPORT_FILE"
            fi
            if [ $INDEXING_FAILED -gt 0 ]; then
              echo "3. **Retry $INDEXING_FAILED failed indexing requests** - Re-run GSC Priority Indexing workflow" >> "$REPORT_FILE"
            fi
          fi
          
          cat >> "$REPORT_FILE" << EOF
          
          ## ðŸ“ Full Reports
          
          - [GitHub Action Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Download All Reports](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [GSC Priority Indexing](https://github.com/${{ github.repository }}/actions/workflows/gsc-priority-indexing.yml)
          
          ---
          
          **Next Digest**: $(date -d "+7 days" +'%Y-%m-%d')  
          **Generated by**: SEO Agent Weekly Digest
          EOF
          
          echo "report_file=$REPORT_FILE" >> $GITHUB_OUTPUT
          echo "audit_date=$AUDIT_DATE" >> $GITHUB_OUTPUT
          echo "total_issues=$TOTAL_ISSUES" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "indexing_success=$INDEXING_SUCCESS" >> $GITHUB_OUTPUT
          echo "indexing_failed=$INDEXING_FAILED" >> $GITHUB_OUTPUT
          
          echo "âœ… Weekly digest report generated: $REPORT_FILE"
      
      - name: ðŸ“ Commit weekly report
        if: env.COMMIT_FIXES == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "SEO Agent"
          
          git add reports/seo/
          
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "ðŸ“Š SEO Weekly Digest - ${{ steps.generate-digest.outputs.audit_date }}

            Status: ${{ steps.generate-digest.outputs.status }}
            Issues Found: ${{ steps.generate-digest.outputs.total_issues }}
            
            - Weekly SEO health check completed
            - Reports saved to reports/seo/
            - Auto-generated by GitHub Actions"
            
            git push || echo "âš ï¸ Could not push changes"
            echo "âœ… Weekly report committed and pushed"
          else
            echo "â„¹ï¸ No new reports to commit"
          fi
        continue-on-error: true
      
      - name: ðŸ“„ Upload comprehensive reports
        uses: actions/upload-artifact@v4
        with:
          name: seo-weekly-digest-${{ steps.generate-digest.outputs.audit_date }}
          path: |
            reports/
          retention-days: 30
        if: always()
      
      - name: ðŸš¨ Create GitHub issue for critical problems
        if: steps.generate-digest.outputs.total_issues > 10
        uses: actions/github-script@v7
        with:
          script: |
            const auditDate = '${{ steps.generate-digest.outputs.audit_date }}';
            const totalIssues = '${{ steps.generate-digest.outputs.total_issues }}';
            const status = '${{ steps.generate-digest.outputs.status }}';
            
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Critical SEO Issues Detected - ${auditDate}`,
              body: `# Critical SEO Issues Alert
              
              **Status**: ${status}  
              **Issues Found**: ${totalIssues}  
              **Audit Date**: ${auditDate}
              
              ## âš¡ Immediate Actions Required
              
              Our automated SEO monitoring has detected **${totalIssues} critical issues** that need immediate attention.
              
              ## ðŸ“Š View Full Report
              
              - [Weekly Digest Report](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/reports/seo/weekly-report-${auditDate}.md)
              - [Detailed Analysis](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              
              ## ðŸ”§ Next Steps
              
              1. Review the detailed weekly report
              2. Fix broken links and sitemap issues
              3. Monitor the next weekly digest for improvements
              
              ---
              
              *Auto-generated by SEO Agent on ${new Date().toLocaleString()}*`,
              labels: ['seo', 'critical', 'automated', 'bug']
            });
            
            console.log(`ðŸš¨ Created critical SEO issue #${issue.number}`);
      
      - name: âœ… Summary
        run: |
          echo "## ðŸ“Š SEO Weekly Digest Complete"
          echo ""
          echo "**Date**: ${{ steps.generate-digest.outputs.audit_date }}"
          echo "**Status**: ${{ steps.generate-digest.outputs.status }}"
          echo "**Issues**: ${{ steps.generate-digest.outputs.total_issues }}"
          echo "**Report**: ${{ steps.generate-digest.outputs.report_file }}"
          echo ""
          echo "Next digest scheduled for $(date -d '+7 days' +'%Y-%m-%d')"