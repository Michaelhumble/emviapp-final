name: ðŸ” SEO Priority URL Indexing

on:
  schedule:
    # Run every Sunday at 6 AM UTC (weekly)
    - cron: '0 6 * * 0'
  workflow_dispatch:  # Allow manual triggering

jobs:
  priority-indexing:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ” Validate GSC Credentials
        id: check-creds
        run: |
          echo "ðŸ”’ Validating Google Search Console credentials..."
          
          if [ -z "${{ secrets.GSC_CLIENT_EMAIL }}" ] || [ -z "${{ secrets.GSC_PRIVATE_KEY }}" ]; then
            echo "âŒ GSC credentials missing - indexing will be skipped"
            echo ""
            echo "ðŸš¨ Missing GSC secrets for priority URL indexing:"
            [ -z "${{ secrets.GSC_CLIENT_EMAIL }}" ] && echo "   - GSC_CLIENT_EMAIL"
            [ -z "${{ secrets.GSC_PRIVATE_KEY }}" ] && echo "   - GSC_PRIVATE_KEY"
            echo ""
            echo "ðŸ“‹ To add GSC secrets:"
            echo "   1. Create Google Service Account with Search Console API access"
            echo "   2. Go to GitHub repo â†’ Settings â†’ Secrets and variables â†’ Actions"
            echo "   3. Add GSC_CLIENT_EMAIL and GSC_PRIVATE_KEY"
            echo ""
            echo "â„¹ï¸ Workflow will continue but indexing functionality will be disabled"
            echo "has_creds=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… GSC credentials found - proceeding with indexing"
            echo "has_creds=true" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ” Submit Priority URLs for Indexing (Attempt 1)
        if: steps.check-creds.outputs.has_creds == 'true'
        id: indexing-attempt-1
        continue-on-error: true
        env:
          GSC_CLIENT_EMAIL: ${{ secrets.GSC_CLIENT_EMAIL }}
          GSC_PRIVATE_KEY: ${{ secrets.GSC_PRIVATE_KEY }}
        run: |
          echo "ðŸš€ Attempting to submit priority URLs for indexing..."
          node scripts/gsc-pulls.mjs --urls=data/priority-urls.json --submitIndexing

      - name: ðŸ”„ Retry Indexing Submission (Attempt 2)
        if: steps.check-creds.outputs.has_creds == 'true' && steps.indexing-attempt-1.outcome == 'failure'
        env:
          GSC_CLIENT_EMAIL: ${{ secrets.GSC_CLIENT_EMAIL }}
          GSC_PRIVATE_KEY: ${{ secrets.GSC_PRIVATE_KEY }}
        run: |
          echo "ðŸ”„ Retrying URL indexing submission..."
          sleep 30  # Wait 30 seconds before retry
          node scripts/gsc-pulls.mjs --urls=data/priority-urls.json --submitIndexing

      - name: ðŸ“Š Log Indexing Results
        if: always()
        run: |
          if [ "${{ steps.check-creds.outputs.has_creds }}" == "false" ]; then
            echo "â­ï¸ Indexing skipped: GSC credentials not configured"
            echo "ðŸ’¡ To enable indexing, add GSC_CLIENT_EMAIL and GSC_PRIVATE_KEY secrets"
          else
            echo "âœ… Priority URL indexing workflow completed"
            if [ -f ".seo-cache/gsc-indexing-$(date +%Y-%m-%d).json" ]; then
              SUBMITTED_COUNT=$(jq -r '.submitted_count // 0' .seo-cache/gsc-indexing-$(date +%Y-%m-%d).json)
              echo "ðŸ“ˆ URLs submitted for indexing: $SUBMITTED_COUNT"
            else
              echo "âš ï¸ No indexing results file found"
            fi
          fi
          
      - name: ðŸ“‹ Summary Report
        if: always()
        run: |
          echo "## ðŸ” SEO Priority Indexing Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow**: Weekly Priority URL Indexing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check-creds.outputs.has_creds }}" == "false" ]; then
            echo "âŒ **Status**: Skipped (Missing GSC Credentials)" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ’¡ **Action Needed**: Configure GSC_CLIENT_EMAIL and GSC_PRIVATE_KEY secrets" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Status**: Completed" >> $GITHUB_STEP_SUMMARY
            if [ -f ".seo-cache/gsc-indexing-$(date +%Y-%m-%d).json" ]; then
              SUBMITTED_COUNT=$(jq -r '.submitted_count // 0' .seo-cache/gsc-indexing-$(date +%Y-%m-%d).json)
              echo "ðŸ“ˆ **URLs Submitted**: $SUBMITTED_COUNT" >> $GITHUB_STEP_SUMMARY
              echo "ðŸŽ¯ **Next Steps**: Monitor GSC Coverage for indexing improvements" >> $GITHUB_STEP_SUMMARY
            fi
          fi