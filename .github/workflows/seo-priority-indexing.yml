name: 🔍 SEO Priority URL Indexing

on:
  schedule:
    # Run every Sunday at 6 AM UTC (weekly)
    - cron: '0 6 * * 0'
  workflow_dispatch:  # Allow manual triggering

jobs:
  priority-indexing:
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 📦 Install Dependencies
        run: npm ci

      - name: 🔐 Validate GSC Credentials
        id: check-creds
        run: |
          echo "🔒 Validating Google Search Console credentials..."
          
          if [ -z "${{ secrets.GSC_CLIENT_EMAIL }}" ] || [ -z "${{ secrets.GSC_PRIVATE_KEY }}" ]; then
            echo "❌ GSC credentials missing - indexing will be skipped"
            echo ""
            echo "🚨 Missing GSC secrets for priority URL indexing:"
            [ -z "${{ secrets.GSC_CLIENT_EMAIL }}" ] && echo "   - GSC_CLIENT_EMAIL"
            [ -z "${{ secrets.GSC_PRIVATE_KEY }}" ] && echo "   - GSC_PRIVATE_KEY"
            echo ""
            echo "📋 To add GSC secrets:"
            echo "   1. Create Google Service Account with Search Console API access"
            echo "   2. Go to GitHub repo → Settings → Secrets and variables → Actions"
            echo "   3. Add GSC_CLIENT_EMAIL and GSC_PRIVATE_KEY"
            echo ""
            echo "ℹ️ Workflow will continue but indexing functionality will be disabled"
            echo "has_creds=false" >> $GITHUB_OUTPUT
          else
            echo "✅ GSC credentials found - proceeding with indexing"
            echo "has_creds=true" >> $GITHUB_OUTPUT
          fi

      - name: 🔍 Submit Priority URLs for Indexing (Attempt 1)
        if: steps.check-creds.outputs.has_creds == 'true'
        id: indexing-attempt-1
        continue-on-error: true
        env:
          GSC_CLIENT_EMAIL: ${{ secrets.GSC_CLIENT_EMAIL }}
          GSC_PRIVATE_KEY: ${{ secrets.GSC_PRIVATE_KEY }}
        run: |
          echo "🚀 Attempting to submit priority URLs for indexing..."
          node scripts/gsc-pulls.mjs --urls=data/priority-urls.json --submitIndexing

      - name: 🔄 Retry Indexing Submission (Attempt 2)
        if: steps.check-creds.outputs.has_creds == 'true' && steps.indexing-attempt-1.outcome == 'failure'
        env:
          GSC_CLIENT_EMAIL: ${{ secrets.GSC_CLIENT_EMAIL }}
          GSC_PRIVATE_KEY: ${{ secrets.GSC_PRIVATE_KEY }}
        run: |
          echo "🔄 Retrying URL indexing submission..."
          sleep 30  # Wait 30 seconds before retry
          node scripts/gsc-pulls.mjs --urls=data/priority-urls.json --submitIndexing

      - name: 📊 Log Indexing Results
        if: always()
        run: |
          if [ "${{ steps.check-creds.outputs.has_creds }}" == "false" ]; then
            echo "⏭️ Indexing skipped: GSC credentials not configured"
            echo "💡 To enable indexing, add GSC_CLIENT_EMAIL and GSC_PRIVATE_KEY secrets"
          else
            echo "✅ Priority URL indexing workflow completed"
            if [ -f ".seo-cache/gsc-indexing-$(date +%Y-%m-%d).json" ]; then
              SUBMITTED_COUNT=$(jq -r '.submitted_count // 0' .seo-cache/gsc-indexing-$(date +%Y-%m-%d).json)
              echo "📈 URLs submitted for indexing: $SUBMITTED_COUNT"
            else
              echo "⚠️ No indexing results file found"
            fi
          fi
          
      - name: 📋 Summary Report
        if: always()
        run: |
          echo "## 🔍 SEO Priority Indexing Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow**: Weekly Priority URL Indexing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check-creds.outputs.has_creds }}" == "false" ]; then
            echo "❌ **Status**: Skipped (Missing GSC Credentials)" >> $GITHUB_STEP_SUMMARY
            echo "💡 **Action Needed**: Configure GSC_CLIENT_EMAIL and GSC_PRIVATE_KEY secrets" >> $GITHUB_STEP_SUMMARY
          else
            echo "✅ **Status**: Completed" >> $GITHUB_STEP_SUMMARY
            if [ -f ".seo-cache/gsc-indexing-$(date +%Y-%m-%d).json" ]; then
              SUBMITTED_COUNT=$(jq -r '.submitted_count // 0' .seo-cache/gsc-indexing-$(date +%Y-%m-%d).json)
              echo "📈 **URLs Submitted**: $SUBMITTED_COUNT" >> $GITHUB_STEP_SUMMARY
              echo "🎯 **Next Steps**: Monitor GSC Coverage for indexing improvements" >> $GITHUB_STEP_SUMMARY
            fi
          fi