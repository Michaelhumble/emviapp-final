name: SEO Weekly Audit & Tracking

on:
  schedule:
    # Run every Monday at 8 AM UTC
    - cron: '0 8 * * 1'
  workflow_dispatch:
    inputs:
      site_url:
        description: 'Site URL to audit (default: production)'
        required: false
        default: 'https://www.emvi.app'
      issue_action:
        description: 'Issue action (create/update/skip)'
        required: false
        default: 'create'

env:
  AUDIT_SITE: ${{ github.event.inputs.site_url || 'https://www.emvi.app' }}
  ISSUE_ACTION: ${{ github.event.inputs.issue_action || 'create' }}

jobs:
  seo-audit:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install deps
        run: |
          npm install --legacy-peer-deps
          npm install -g lighthouse @lhci/cli
          
      - name: Create reports directory
        run: mkdir -p reports
        
      - name: üîê Validate Required Secrets
        id: validate-secrets
        run: |
          echo "üîí Validating required secrets for SEO Weekly Audit..."
          
          MISSING_SECRETS=()
          INVALID_SECRETS=()
          
          if [ -z "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "‚ùå OPENAI_API_KEY is missing"
            MISSING_SECRETS+=("OPENAI_API_KEY")
          else
            echo "‚úÖ OPENAI_API_KEY configured"
          fi
          
          if [ -z "${{ secrets.GSC_CLIENT_EMAIL }}" ]; then
            echo "‚ùå GSC_CLIENT_EMAIL is missing"
            MISSING_SECRETS+=("GSC_CLIENT_EMAIL")
          else
            # Validate GSC_CLIENT_EMAIL format
            if [[ "${{ secrets.GSC_CLIENT_EMAIL }}" != *"@"*".iam.gserviceaccount.com" ]]; then
              echo "‚ùå GSC_CLIENT_EMAIL format invalid - should end with .iam.gserviceaccount.com"
              INVALID_SECRETS+=("GSC_CLIENT_EMAIL")
            else
              echo "‚úÖ GSC_CLIENT_EMAIL configured"
            fi
          fi
          
          if [ -z "${{ secrets.GSC_PRIVATE_KEY }}" ]; then
            echo "‚ùå GSC_PRIVATE_KEY is missing"
            MISSING_SECRETS+=("GSC_PRIVATE_KEY")
          else
            # Validate GSC_PRIVATE_KEY format
            PRIVATE_KEY="${{ secrets.GSC_PRIVATE_KEY }}"
            if [[ "$PRIVATE_KEY" != *"-----BEGIN PRIVATE KEY-----"* ]] || [[ "$PRIVATE_KEY" != *"-----END PRIVATE KEY-----"* ]]; then
              echo "‚ùå GSC_PRIVATE_KEY format invalid - missing BEGIN/END PRIVATE KEY markers"
              INVALID_SECRETS+=("GSC_PRIVATE_KEY")
            elif [[ "$PRIVATE_KEY" != *"\\n"* ]]; then
              echo "‚ùå GSC_PRIVATE_KEY format invalid - missing \\n newline sequences"
              INVALID_SECRETS+=("GSC_PRIVATE_KEY")
            else
              echo "‚úÖ GSC_PRIVATE_KEY configured"
            fi
          fi
          
          # Optional secrets
          if [ -n "${{ secrets.PAGESPEED_API_KEY }}" ]; then
            echo "‚úÖ PAGESPEED_API_KEY configured"
          else
            echo "‚ÑπÔ∏è PAGESPEED_API_KEY not set - will use Lighthouse fallback"
          fi
          
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "‚úÖ SLACK_WEBHOOK_URL configured"
          else
            echo "‚ÑπÔ∏è Slack notifications disabled"
          fi
          
          # Set outputs for conditional steps
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo ""
            echo "üö® CRITICAL: Missing required secrets:"
            for secret in "${MISSING_SECRETS[@]}"; do
              echo "   - $secret"
            done
            echo ""
            echo "üìã Add secrets at: GitHub repo ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions"
            exit 1
          fi
          
          if [ ${#INVALID_SECRETS[@]} -gt 0 ]; then
            echo ""
            echo "‚ö†Ô∏è WARNING: Invalid secret format detected:"
            for secret in "${INVALID_SECRETS[@]}"; do
              echo "   - $secret"
            done
            echo ""
            echo "‚ÑπÔ∏è GSC tasks will be skipped but local audits will continue"
            echo "gsc_available=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ GSC auth OK" 
            echo "gsc_available=true" >> $GITHUB_OUTPUT
          fi
          
          echo "DRY_RUN=false"

      - name: Run SEO audit
        env:
          AUDIT_SITE: ${{ env.AUDIT_SITE }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GSC_CLIENT_EMAIL: ${{ secrets.GSC_CLIENT_EMAIL }}
          GSC_PRIVATE_KEY: ${{ secrets.GSC_PRIVATE_KEY }}
          DRY_RUN: false
        run: |
          echo "üîç Running SEO audit for $AUDIT_SITE"
          echo "DRY_RUN=false"
          
          # Set GSC environment based on validation
          if [ "${{ steps.validate-secrets.outputs.gsc_available }}" = "false" ]; then
            echo "‚ÑπÔ∏è GSC skipped (missing/invalid creds)"
            unset GSC_CLIENT_EMAIL
            unset GSC_PRIVATE_KEY
          fi
          
          if [ -f "scripts/audit-seo.mjs" ]; then
            node scripts/audit-seo.mjs --site=$AUDIT_SITE --out=reports --maxDepth=4
          else
            echo "‚ö†Ô∏è audit-seo.mjs not found, running basic lighthouse audit"
            lighthouse $AUDIT_SITE --output=html --output-path=reports/seo-report.html --only-categories=seo --chrome-flags="--headless --no-sandbox"
          fi
        continue-on-error: true
        
      - name: Validate sitemaps
        env:
          DRY_RUN: false
        run: |
          echo "üó∫Ô∏è Validating sitemaps"
          SITEMAP_BASE_URL=$AUDIT_SITE node scripts/validate-sitemaps.mjs
        continue-on-error: true
        
      - name: Generate GSC data (stub)
        env:
          GSC_CLIENT_EMAIL: ${{ secrets.GSC_CLIENT_EMAIL }}
          GSC_PRIVATE_KEY: ${{ secrets.GSC_PRIVATE_KEY }}
          DRY_RUN: false
        run: |
          echo "üìä Pulling Google Search Console data"
          echo "DRY_RUN=false"
          
          if [ "${{ steps.validate-secrets.outputs.gsc_available }}" = "false" ]; then
            echo "‚ÑπÔ∏è GSC skipped (missing/invalid creds)"
          elif [ -f "scripts/gsc-pulls.mjs" ]; then
            node scripts/gsc-pulls.mjs || echo "GSC pull failed, continuing..."
          else
            echo "GSC pull script not found, skipping..."
          fi
        continue-on-error: true
        
      - name: Collect Core Web Vitals
        env:
          PAGESPEED_API_KEY: ${{ secrets.PAGESPEED_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          echo "üìä Collecting Core Web Vitals data..."
          
          if [ -f "scripts/collect-cwv.mjs" ]; then
            if [ -n "$PAGESPEED_API_KEY" ]; then
              echo "CWV mode: PageSpeed"
            else
              echo "CWV mode: Lighthouse fallback"
            fi
            node scripts/collect-cwv.mjs --urls=data/priority-urls.json
            
            # Merge CWV data into weekly report
            if [ -f ".seo-cache/cwv-$(date +%Y-%m-%d).json" ] && [ -f "reports/weekly.md" ]; then
              echo "" >> reports/weekly.md
              echo "## Core Web Vitals - $(date +%Y-%m-%d)" >> reports/weekly.md
              echo "" >> reports/weekly.md
              node -e "
                try {
                  const fs = require('fs');
                  const cwvData = JSON.parse(fs.readFileSync('.seo-cache/cwv-$(date +%Y-%m-%d).json', 'utf8'));
                  const analysis = cwvData.analysis;
                  
                  console.log('**CWV Collection Mode**: ' + (process.env.PAGESPEED_API_KEY ? 'PageSpeed Insights API' : 'Lighthouse Fallback'));
                  console.log('**URLs Tested**: ' + analysis.total_urls);
                  console.log('**Successful Tests**: ' + analysis.successful);
                  console.log('');
                  console.log('### Performance Summary');
                  console.log('| Metric | Good | Needs Improvement | Poor |');
                  console.log('|--------|------|-------------------|------|');
                  Object.keys(analysis.summary).forEach(metric => {
                    const data = analysis.summary[metric];
                    console.log('| ' + metric + ' | ' + data.good + ' | ' + data.needsImprovement + ' | ' + data.poor + ' |');
                  });
                  
                  if (analysis.alerts.length > 0) {
                    console.log('');
                    console.log('### ‚ö†Ô∏è Performance Alerts');
                    analysis.alerts.slice(0, 3).forEach(alert => {
                      console.log('- **' + alert.metric + '**: ' + alert.value + (alert.metric === 'CLS' ? '' : 'ms') + ' on ' + alert.url);
                    });
                  }
                } catch(e) {
                  console.log('CWV data merge failed:', e.message);
                }
              " >> reports/weekly.md
            fi
          else
            echo "‚ö†Ô∏è CWV collection script not found - skipping Core Web Vitals"
          fi
        continue-on-error: true
        
      - name: Parse audit results and create summary
        id: parse-results
        run: |
          echo "üìã Parsing audit results..."
          
          # Initialize counters
          broken_links=0
          seo_issues=0
          sitemap_issues=0
          missing_canonicals=0
          missing_jsonld=0
          
          # Parse broken links
          if [ -f "reports/broken-links.csv" ]; then
            broken_links=$(tail -n +2 reports/broken-links.csv | wc -l)
          fi
          
          # Parse SEO issues  
          if [ -f "reports/seo-issues.csv" ]; then
            seo_issues=$(tail -n +2 reports/seo-issues.csv | wc -l)
            missing_canonicals=$(grep -c "missing-canonical" reports/seo-issues.csv || echo "0")
            missing_jsonld=$(grep -c "invalid-json-ld\|missing.*schema" reports/seo-issues.csv || echo "0")
          fi
          
          # Parse sitemap validation
          if [ -f "reports/sitemap-validation.json" ]; then
            sitemap_issues=$(node -p "
              try {
                const data = JSON.parse(require('fs').readFileSync('reports/sitemap-validation.json', 'utf8'));
                data.summary.broken + data.summary.errors;
              } catch(e) { 0 }
            ")
          fi
          
          # Set outputs for next step
          echo "broken_links=$broken_links" >> $GITHUB_OUTPUT
          echo "seo_issues=$seo_issues" >> $GITHUB_OUTPUT
          echo "sitemap_issues=$sitemap_issues" >> $GITHUB_OUTPUT
          echo "missing_canonicals=$missing_canonicals" >> $GITHUB_OUTPUT
          echo "missing_jsonld=$missing_jsonld" >> $GITHUB_OUTPUT
          
          # Generate date for issue title
          echo "audit_date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          
          # Set total issues count
          total_issues=$((broken_links + sitemap_issues))
          echo "total_issues=$total_issues" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Results parsed: $broken_links broken links, $seo_issues SEO issues, $sitemap_issues sitemap issues"
          
      - name: Create audit summary markdown
        id: create-summary
        run: |
          audit_date="${{ steps.parse-results.outputs.audit_date }}"
          broken_links="${{ steps.parse-results.outputs.broken_links }}"
          seo_issues="${{ steps.parse-results.outputs.seo_issues }}"
          sitemap_issues="${{ steps.parse-results.outputs.sitemap_issues }}"
          missing_canonicals="${{ steps.parse-results.outputs.missing_canonicals }}"
          missing_jsonld="${{ steps.parse-results.outputs.missing_jsonld }}"
          
          # Determine overall status
          total_issues=$((broken_links + sitemap_issues))
          if [ $total_issues -eq 0 ]; then
            status="üü¢ GOOD"
            priority="low"
          elif [ $total_issues -lt 5 ]; then
            status="üü° ATTENTION"
            priority="medium"
          else
            status="üî¥ ACTION REQUIRED"
            priority="high"
          fi
          
          # Create summary markdown
          cat > reports/weekly-summary.md << EOF
          # SEO Weekly Audit - $audit_date
          
          **Overall Status**: $status
          **Audit Target**: [\`$AUDIT_SITE\`]($AUDIT_SITE)
          **Generated**: $(date -u +'%Y-%m-%d %H:%M UTC')
          
          ## üìä Summary Metrics
          
          | Metric | Count | Status |
          |--------|-------|--------|
          | üîó Broken Links | $broken_links | $([ $broken_links -eq 0 ] && echo "‚úÖ" || echo "‚ùå") |
          | üó∫Ô∏è Sitemap Issues | $sitemap_issues | $([ $sitemap_issues -eq 0 ] && echo "‚úÖ" || echo "‚ùå") |
          | üìÑ SEO Issues | $seo_issues | $([ $seo_issues -lt 5 ] && echo "‚úÖ" || echo "‚ö†Ô∏è") |
          | üîó Missing Canonicals | $missing_canonicals | $([ $missing_canonicals -eq 0 ] && echo "‚úÖ" || echo "‚ùå") |
          | üìã Missing Schema | $missing_jsonld | $([ $missing_jsonld -eq 0 ] && echo "‚úÖ" || echo "‚ùå") |
          
          ## üîç Detailed Findings
          
          ### Broken Links $([ $broken_links -eq 0 ] && echo "‚úÖ" || echo "($broken_links found)")
          EOF
          
          # Add broken links details if any exist
          if [ $broken_links -gt 0 ] && [ -f "reports/broken-links.csv" ]; then
            echo "" >> reports/weekly-summary.md
            echo "**Top 10 Broken Links:**" >> reports/weekly-summary.md
            echo "\`\`\`" >> reports/weekly-summary.md
            head -11 reports/broken-links.csv | tail -10 >> reports/weekly-summary.md
            echo "\`\`\`" >> reports/weekly-summary.md
          else
            echo "No broken links detected! üéâ" >> reports/weekly-summary.md
          fi
          
          cat >> reports/weekly-summary.md << EOF
          
          ### Sitemap Validation $([ $sitemap_issues -eq 0 ] && echo "‚úÖ" || echo "($sitemap_issues issues)")
          EOF
          
          # Add sitemap issues if any
          if [ $sitemap_issues -gt 0 ] && [ -f "reports/sitemap-validation.json" ]; then
            echo "" >> reports/weekly-summary.md
            echo "**Issues found in sitemap validation. Check the full report for details.**" >> reports/weekly-summary.md
          else
            echo "All sitemap URLs are valid and accessible! üéâ" >> reports/weekly-summary.md
          fi
          
          cat >> reports/weekly-summary.md << EOF
          
          ### SEO Technical Issues $([ $seo_issues -lt 5 ] && echo "‚úÖ" || echo "($seo_issues issues)")
          EOF
          
          if [ $seo_issues -gt 0 ] && [ -f "reports/seo-issues.csv" ]; then
            echo "" >> reports/weekly-summary.md
            echo "**Common Issues:**" >> reports/weekly-summary.md
            echo "- Missing canonical URLs: $missing_canonicals" >> reports/weekly-summary.md  
            echo "- Schema markup issues: $missing_jsonld" >> reports/weekly-summary.md
            echo "" >> reports/weekly-summary.md
            echo "**Sample Issues:**" >> reports/weekly-summary.md
            echo "\`\`\`" >> reports/weekly-summary.md
            head -6 reports/seo-issues.csv | tail -5 >> reports/weekly-summary.md
            echo "\`\`\`" >> reports/weekly-summary.md
          else
            echo "No major SEO issues detected! ‚ú®" >> reports/weekly-summary.md
          fi
          
          cat >> reports/weekly-summary.md << EOF
          
          ## üéØ Recommended Actions
          
          EOF
          
          # Add priority recommendations
          if [ $broken_links -gt 0 ]; then
            echo "1. **Fix Broken Links** - Review and update $broken_links broken links" >> reports/weekly-summary.md
          fi
          
          if [ $missing_canonicals -gt 0 ]; then
            echo "2. **Add Canonical URLs** - $missing_canonicals pages missing canonical tags" >> reports/weekly-summary.md
          fi
          
          if [ $missing_jsonld -gt 0 ]; then
            echo "3. **Fix Schema Markup** - $missing_jsonld pages with schema issues" >> reports/weekly-summary.md
          fi
          
          if [ $total_issues -eq 0 ]; then
            echo "üéâ **No immediate actions required!** Your SEO is in great shape." >> reports/weekly-summary.md
          fi
          
          cat >> reports/weekly-summary.md << EOF
          
          ## üìÅ Full Reports
          
          - [SEO Audit Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Broken Links CSV](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Sitemap Validation](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ---
          
          **Next audit**: $(date -d "+7 days" +'%Y-%m-%d')  
          **Generated by**: [SEO Weekly Audit Action](https://github.com/${{ github.repository }}/actions/workflows/seo-weekly.yml)
          EOF
          
          echo "status=$status" >> $GITHUB_OUTPUT
          echo "priority=$priority" >> $GITHUB_OUTPUT
          echo "total_issues=$total_issues" >> $GITHUB_OUTPUT
          
      - name: Upload audit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: seo-audit-${{ steps.parse-results.outputs.audit_date }}
          path: |
            reports/
          retention-days: 30
          
      - name: Create or update tracking issue
        if: env.ISSUE_ACTION != 'skip'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const auditDate = '${{ steps.parse-results.outputs.audit_date }}';
            const status = '${{ steps.create-summary.outputs.status }}';
            const priority = '${{ steps.create-summary.outputs.priority }}';
            const totalIssues = parseInt('${{ steps.create-summary.outputs.total_issues }}');
            
            // Read the summary
            const summary = fs.readFileSync('reports/weekly-summary.md', 'utf8');
            
            const issueTitle = `SEO Weekly ‚Äì ${auditDate}`;
            const labels = ['seo', 'automated', `priority:${priority}`];
            
            if (totalIssues > 0) {
              labels.push('bug');
            }
            
            // Check for existing issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'seo,automated',
              state: 'open',
              sort: 'created',
              direction: 'desc',
              per_page: 5
            });
            
            // Look for recent issue (within 14 days) to update instead of creating new
            const recentIssue = issues.find(issue => {
              const createdDate = new Date(issue.created_at);
              const daysDiff = (new Date() - createdDate) / (1000 * 60 * 60 * 24);
              return daysDiff <= 14 && issue.title.includes('SEO Weekly');
            });
            
            if (recentIssue && '${{ env.ISSUE_ACTION }}' === 'update') {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: recentIssue.number,
                body: `## Update: ${auditDate}\n\n${summary}`
              });
              
              // Update labels if priority changed
              await github.rest.issues.setLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: recentIssue.number,
                labels: labels
              });
              
              console.log(`Updated existing issue #${recentIssue.number}`);
            } else {
              // Create new issue
              const { data: newIssue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: summary,
                labels: labels
              });
              
              console.log(`Created new issue #${newIssue.number}`);
            }
            
      - name: Notify on critical issues
        if: steps.create-summary.outputs.total_issues > 10
        uses: actions/github-script@v7
        with:
          script: |
            const totalIssues = '${{ steps.create-summary.outputs.total_issues }}';
            console.log(`üö® CRITICAL: ${totalIssues} SEO issues detected!`);
            
            // Could add Slack/email notifications here
            core.setFailed(`Critical SEO issues detected: ${totalIssues} issues found`);
            
      - name: Summary
        run: |
          echo "## üìä SEO Weekly Audit Complete"
          echo "- **Site**: $AUDIT_SITE"
          echo "- **Status**: ${{ steps.create-summary.outputs.status }}"
          echo "- **Issues**: ${{ steps.create-summary.outputs.total_issues }}"
          echo "- **Reports**: Available in workflow artifacts"
          echo ""
          echo "Next audit scheduled for $(date -d '+7 days' +'%Y-%m-%d')"